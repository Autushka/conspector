/*
 * #%L
 * ProjectX2013_03_23_web
 * %%
 * Copyright (C) 2013 - 2014 Powered by Sergey
 * %%
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * #L%
 */
if(!window.console)console={log:function(){}};var textAngular=angular.module("textAngular",["ngSanitize"]);textAngular.directive("textAngular",["$compile","$window","$document","$rootScope","$timeout","taFixChrome",function(t,e,a,n,l,i){console.log("Thank you for using textAngular! http://www.textangular.com");function o(t,e){for(var a in e){if(e[a]&&e[a].constructor&&e[a].constructor===Object){t[a]=t[a]||{};arguments.callee(t[a],e[a])}else{t[a]=e[a]}}return t}n.textAngularOpts=o({toolbar:[["h1","h2","h3","p","pre","quote"],["bold","italics","underline","ul","ol","redo","undo","clear"],["justifyLeft","justifyCenter","justifyRight"],["html","insertImage","insertLink","unlink"]],classes:{focussed:"focussed",toolbar:"btn-toolbar",toolbarGroup:"btn-group",toolbarButton:"btn btn-default",toolbarButtonActive:"active",textEditor:"form-control",htmlEditor:"form-control"}},n.textAngularOpts!=null?n.textAngularOpts:{});var s=function(t){t=t.toLowerCase();var e=a[0].queryCommandValue("formatBlock").toLowerCase();return e===t||e===t};n.textAngularTools=o({html:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'>HTML</button>",action:function(){var t,e=this;this.$parent.showHtml=!this.$parent.showHtml;if(this.$parent.showHtml){l(function(){return e.$parent.displayElements.html[0].focus()},100)}else{l(function(){return e.$parent.displayElements.text[0].focus()},100)}this.active=this.$parent.showHtml}},h1:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'>H1</button>",action:function(){return this.$parent.wrapSelection("formatBlock","<H1>")},activeState:function(){return s("h1")}},h2:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'>H2</button>",action:function(){return this.$parent.wrapSelection("formatBlock","<H2>")},activeState:function(){return s("h2")}},h3:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'>H3</button>",action:function(){return this.$parent.wrapSelection("formatBlock","<H3>")},activeState:function(){return s("h3")}},p:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'>P</button>",action:function(){return this.$parent.wrapSelection("formatBlock","<P>")},activeState:function(){return s("p")}},pre:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'>pre</button>",action:function(){return this.$parent.wrapSelection("formatBlock","<PRE>")},activeState:function(){return s("pre")}},ul:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-list-ul'></i></button>",action:function(){return this.$parent.wrapSelection("insertUnorderedList",null)},activeState:function(){return a[0].queryCommandState("insertUnorderedList")}},ol:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-list-ol'></i></button>",action:function(){return this.$parent.wrapSelection("insertOrderedList",null)},activeState:function(){return a[0].queryCommandState("insertOrderedList")}},quote:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-quote-right'></i></button>",action:function(){return this.$parent.wrapSelection("formatBlock","<BLOCKQUOTE>")},activeState:function(){return s("blockquote")}},undo:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-undo'></i></button>",action:function(){return this.$parent.wrapSelection("undo",null)}},redo:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-repeat'></i></button>",action:function(){return this.$parent.wrapSelection("redo",null)}},bold:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-bold'></i></button>",action:function(){return this.$parent.wrapSelection("bold",null)},activeState:function(){return a[0].queryCommandState("bold")}},justifyLeft:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-align-left'></i></button>",action:function(){return this.$parent.wrapSelection("justifyLeft",null)},activeState:function(){return a[0].queryCommandState("justifyLeft")}},justifyRight:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-align-right'></i></button>",action:function(){return this.$parent.wrapSelection("justifyRight",null)},activeState:function(){return a[0].queryCommandState("justifyRight")}},justifyCenter:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-align-center'></i></button>",action:function(){return this.$parent.wrapSelection("justifyCenter",null)},activeState:function(){return a[0].queryCommandState("justifyCenter")}},italics:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-italic'></i></button>",action:function(){return this.$parent.wrapSelection("italic",null)},activeState:function(){return a[0].queryCommandState("italic")}},underline:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-underline'></i></button>",action:function(){return this.$parent.wrapSelection("underline",null)},activeState:function(){return a[0].queryCommandState("underline")}},clear:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-ban'></i></button>",action:function(){return this.$parent.wrapSelection("removeFormat",null)}},insertImage:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-picture-o'></i></button>",action:function(){var t;t=prompt("Please enter an image URL to insert","http://");if(t!==""){return this.$parent.wrapSelection("insertImage",t)}}},insertLink:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-link'></i></button>",action:function(){var t;t=prompt("Please enter an URL to insert","http://");if(t!==""){return this.$parent.wrapSelection("createLink",t)}}},unlink:{display:"<button type='button' ng-click='action()' ng-class='displayActiveToolClass(active)'><i class='fa fa-unlink'></i></button>",action:function(){return this.$parent.wrapSelection("unlink",null)}}},n.textAngularTools!=null?n.textAngularTools:{});return{require:"?ngModel",scope:{},restrict:"EA",link:function(e,o,s,r){var c,u,d,p,f,m;angular.extend(e,n.textAngularOpts,{wrapSelection:function(t,a){document.execCommand(t,false,a);if(t==="insertUnorderedList"||t==="insertOrderedList")i(e.displayElements.text);if(e.showHtml)e.displayElements.html[0].focus();else e.displayElements.text[0].focus();e.updateSelectedStyles();if(!e.showHtml)e.updateTaBindtext()},showHtml:false});if(!!s.taToolbar)e.toolbar=e.$eval(s.taToolbar);if(!!s.taFocussedClass)e.classes.focussed=e.$eval(s.taFocussedClass);if(!!s.taToolbarClass)e.classes.toolbar=s.taToolbarClass;if(!!s.taToolbarGroupClass)e.classes.toolbarGroup=s.taToolbarGroupClass;if(!!s.taToolbarButtonClass)e.classes.toolbarButton=s.taToolbarButtonClass;if(!!s.taToolbarActiveButtonClass)e.classes.toolbarButtonActive=s.taToolbarActiveButtonClass;if(!!s.taTextEditorClass)e.classes.textEditor=s.taTextEditorClass;if(!!s.taHtmlEditorClass)e.classes.htmlEditor=s.taHtmlEditorClass;var y=o.html();o.html("");e.displayElements={toolbar:angular.element("<div></div>"),forminput:angular.element("<input type='hidden' style='display: none;'>"),html:angular.element("<textarea ng-show='showHtml' ta-bind='html' ng-model='html' ></textarea>"),text:angular.element("<div contentEditable='true' ng-hide='showHtml' ta-bind='text' ng-model='text' ></div>")};o.append(e.displayElements.toolbar);o.append(e.displayElements.text);o.append(e.displayElements.html);if(!!s.name){e.displayElements.forminput.attr("name",s.name);o.append(e.displayElements.forminput)}if(!!s.taDisabled){e.displayElements.text.attr("ta-readonly","disabled");e.displayElements.html.attr("ta-readonly","disabled");e.disabled=e.$parent.$eval(s.taDisabled);e.$parent.$watch(s.taDisabled,function(t){e.disabled=t;if(e.disabled){o.addClass("disabled")}else{o.removeClass("disabled")}})}t(e.displayElements.text)(e);t(e.displayElements.html)(e);o.addClass("ta-root");e.displayElements.toolbar.addClass("ta-toolbar "+e.classes.toolbar);e.displayElements.text.addClass("ta-text ta-editor "+e.classes.textEditor);e.displayElements.html.addClass("ta-html ta-editor "+e.classes.textEditor);o.on("focusin",function(){o.addClass(e.classes.focussed);l(function(){o.triggerHandler("focus")},0)});o.on("focusout",function(){l(function(){if(!(a[0].activeElement===e.displayElements.html[0])&&!(a[0].activeElement===e.displayElements.text[0])){o.removeClass(e.classes.focussed);l(function(){o.triggerHandler("blur")},0)}},0)});e.tools={};for(var b=0;b<e.toolbar.length;b++){c=e.toolbar[b];u=angular.element("<div></div>");u.addClass(e.classes.toolbarGroup);for(var g=0;g<c.length;g++){f=c[g];m=angular.element(n.textAngularTools[f].display);m.addClass(e.classes.toolbarButton);m.attr("unselectable","on");m.attr("ng-disabled","showHtml()");var v=angular.extend(e.$new(true),n.textAngularTools[f],{name:f,showHtml:function(){if(this.name!=="html")return this.$parent.disabled||this.$parent.showHtml;return this.$parent.disabled},displayActiveToolClass:function(t){return t?this.$parent.classes.toolbarButtonActive:""}});e.tools[f]=v;u.append(t(m)(v))}e.displayElements.toolbar.append(u)}if(s.ngModel){r.$render=function(){e.displayElements.forminput.val(r.$viewValue);if(r.$viewValue===undefined)return;if(!(a[0].activeElement===e.displayElements.html[0])&&!(a[0].activeElement===e.displayElements.text[0])){var t=r.$viewValue||"";e.text=t;e.html=t}}}else{e.displayElements.forminput.val(y);e.text=y;e.html=y}e.$watch("text",function(t,a){e.html=t;if(s.ngModel)r.$setViewValue(t);e.displayElements.forminput.val(t)});e.$watch("html",function(t,a){e.text=t;if(s.ngModel)r.$setViewValue(t);e.displayElements.forminput.val(t)});e.bUpdateSelectedStyles=false;e.updateSelectedStyles=function(){for(var t=0;t<e.toolbar.length;t++){var a=e.toolbar[t];for(var n=0;n<a.length;n++){f=a[n];if(e.tools[f].activeState!=null){e.tools[f].active=e.tools[f].activeState.apply(e)}}}if(this.bUpdateSelectedStyles)l(this.updateSelectedStyles,200)};d=function(t){e.bUpdateSelectedStyles=true;e.$apply(function(){e.updateSelectedStyles()})};e.displayElements.html.on("keydown",d);e.displayElements.text.on("keydown",d);p=function(t){e.bUpdateSelectedStyles=false};e.displayElements.html.on("keyup",p);e.displayElements.text.on("keyup",p);mouseup=function(t){e.$apply(function(){e.updateSelectedStyles()})};e.displayElements.html.on("mouseup",mouseup);e.displayElements.text.on("mouseup",mouseup)}}}]).directive("taBind",["$sanitize","$document","taFixChrome",function(t,e,a){return{require:"ngModel",scope:{taBind:"@"},link:function(n,l,i,o){var s=l[0].tagName.toLowerCase()!=="textarea"&&l[0].tagName.toLowerCase()!=="input"&&l.attr("contenteditable")!==undefined&&l.attr("contenteditable");var r=false;var c=function(){var t=a(angular.element("<div>").append(l.html())).html();if(n.taBind==="html"&&s)t=t.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&");return t};n.$parent["updateTaBind"+n.taBind]=function(){var t=c();var e=o.$parsers;o.$parsers=[];o.$oldViewValue=t;o.$setViewValue(t);o.$parsers=e};if(s){l.on("keyup",function(t){if(!r)o.$setViewValue(c())})}o.$parsers.push(function(e){if(o.$oldViewValue===undefined)o.$oldViewValue=e;try{t(e)}catch(a){return o.$oldViewValue}o.$oldViewValue=e;return e});o.$render=function(){if(o.$viewValue===undefined)return;if(e[0].activeElement!==l[0]){var t=o.$viewValue||"";o.$oldViewValue=t;if(n.taBind==="text"){l.html(t);l.find("a").on("click",function(t){t.preventDefault();return false})}else if(s||l[0].tagName.toLowerCase()!=="textarea"&&l[0].tagName.toLowerCase()!=="input")l.html(t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));else l.val(t)}else if(!s)l.val(t)};if(!!i.taReadonly){n.$parent.$watch(i.taReadonly,function(t,e){if(e===t)return;if(t){if(l[0].tagName.toLowerCase()==="textarea"||l[0].tagName.toLowerCase()==="input")l.attr("disabled","disabled");if(l.attr("contenteditable")!==undefined&&l.attr("contenteditable"))l.removeAttr("contenteditable")}else{if(l[0].tagName.toLowerCase()==="textarea"||l[0].tagName.toLowerCase()==="input")l.removeAttr("disabled");else if(s)l.attr("contenteditable","true")}r=t})}}}}]).factory("taFixChrome",function(){var t=function(t){var e=angular.element(t).find("span");for(var a=0;a<e.length;a++){var n=angular.element(e[a]);if(n.attr("style")&&n.attr("style").match(/line-height: 1.428571429;|color: inherit; line-height: 1.1;/i)){if(n.next().length>0&&n.next()[0].tagName==="BR")n.next().remove();n.replaceWith(n.html())}}var l=t.html().replace(/style="[^"]*?(line-height: 1.428571429;|color: inherit; line-height: 1.1;)[^"]*"/gi,"");t.html(l);return t};return t});